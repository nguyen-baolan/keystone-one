{{ define "main" }}
  <section class="section pt-7">
    <div class="container">
      <div class="row justify-center">
        <article class="lg:col-10">
          {{/* Deep-dive back navigation (Pattern A) */}}
          {{ with .Params.parent_case }}
            {{ $hub := site.GetPage (printf "work/%s" .) }}
            {{ if $hub }}
              <div class="mb-6">
                <a class="btn btn-outline-primary btn-sm" href="{{ $hub.RelPermalink }}">← Back to case hub</a>
              </div>
            {{ end }}
          {{ end }}

          {{/*
            Resolve images from the Hugo assets pipeline when possible.

            Why:
            - In this repo many images live in `assets/images/...`.
            - Simply outputting `/images/foo.jpg` does NOT guarantee Hugo will publish that file.
            - Using `resources.Get` ensures the asset is discovered & emitted, fixing the
              "works only if used elsewhere first" behavior.

            Accepts either:
            - "/images/foo.jpg" (leading slash)
            - "images/foo.jpg" (no leading slash)
            - External URLs (fallback to relURL).
          */}}
          {{ $image := .Params.image }}
          {{ if $image }}
            <div class="mb-10">
              {{ $imgPath := strings.TrimPrefix "/" $image }}
              {{ with resources.Get $imgPath }}
                <img src="{{ .RelPermalink }}" alt="{{ $.Title }}" class="w-full rounded" />
              {{ else }}
                <img src="{{ $image | relURL }}" alt="{{ .Title }}" class="w-full rounded" />
              {{ end }}
            </div>
          {{ end }}

          <h1 class="h2 mb-6">{{ .Title }}</h1>

          {{/*
            Optional rich layout sections (mirrors the homepage “features” layout).

            Content schema (front matter):
              sections:
                - title: "..."
                  image: "/images/...png"
                  content: "..."        # markdown supported
                  bulletpoints:         # optional
                    - "..."
          */}}
          {{ with .Params.sections }}
            <div class="mb-10">
              {{ range $i, $s := . }}
                <section class="section-sm {{ if (modBool $i 2) }}bg-gradient{{ end }}">
                  <div class="container px-0">
                    <div class="row items-center justify-between">
                      <div class="mb:md-0 {{ if not (modBool $i 2) }}md:order-2{{ end }} md:col-5 mb-6">
                        {{ with $s.image }}
                          {{ $sectionImg := . }}
                          {{ $sectionImgPath := strings.TrimPrefix "/" $sectionImg }}
                          {{ with resources.Get $sectionImgPath }}
                            <img src="{{ .RelPermalink }}" alt="section image" class="w-full rounded" />
                          {{ else }}
                            <img src="{{ $sectionImg | relURL }}" alt="section image" class="w-full rounded" />
                          {{ end }}
                        {{ end }}
                      </div>
                      <div class="{{ if not (modBool $i 2) }}md:order-1{{ end }} md:col-7 lg:col-6">
                        {{ with $s.title }}
                          <h2 class="mb-4">{{ . | markdownify }}</h2>
                        {{ end }}
                        {{ with $s.content }}
                          <p class="mb-8 text-lg">{{ . | markdownify }}</p>
                        {{ end }}
                        {{ with $s.bulletpoints }}
                          <ul>
                            {{ range . }}
                              <li class="relative mb-4 pl-6">
                                <i class="fa fa-check absolute left-0 top-1.5"></i>
                                {{ . | markdownify }}
                              </li>
                            {{ end }}
                          </ul>
                        {{ end }}
                      </div>
                    </div>
                  </div>
                </section>
              {{ end }}
            </div>
          {{ end }}

          <div class="content mb-10">
            {{/* Keep TOC for readability on long case studies */}}
            {{ with .TableOfContents }}
              <div class="toc mb-6">
                <h3 class="text-lg font-semibold mb-2">Table of Contents</h3>
                {{ . }}
              </div>
            {{ end }}
            {{ .Content }}
          </div>

          {{/* Optional: manually-curated related case studies (cards match /work/) */}}
          {{ partial "components/related-cases" . }}

          {{/*
            IMPORTANT: No Disqus / comments for case studies.
            Also: no blog-only metadata (author/categories/tags UI).
          */}}
        </article>
      </div>
    </div>
  </section>
{{ end }}